<!doctype html>
<html lang='es'>
<head>
    <meta charset='utf-8'/>
    <meta name='viewport' content='width=device-width, initial-scale=1'/>
    <title>EduMon Dashboard</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; background: #fafafa; }
        h1 { font-size: 20px; }
        table { border-collapse: collapse; width: 100%; background: #fff; }
        th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
        th { background: #f0f0f0; text-align: left; }
        .muted { color: #666; font-size: 12px; }
        .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
        .status-active { background:#19c37d; }
        .status-connected { background:#19c37d; }
        .status-inactive { background:#f6c744; }
        .status-disconnected { background:#ef4444; }
        .btn { background:#2563eb; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; margin-right:6px; }
        .btn:hover { background:#1d4ed8; }
        .toolbar { margin:8px 0 12px; }
    </style>
</head>
<body>
    <h1>EduMon - Panel de aula</h1>
    <p class='muted'>Solo métricas mínimas.</p>
    <p id="summary">Total: 0 | En línea: 0 | Inactivo: 0 | Desconectado: 0</p>
    <form method='get' action='/' style='margin:8px 0;'>
        <label for='classroom'>Filtrar por aula:</label>
        <input type='text' name='classroom' id='classroom' placeholder='Sala-1' value='' />
        <button type='submit'>Filtrar</button>
    </form>
    <div class='toolbar'>
        <button type='button' class='btn' id='downloadCsv'>Descargar CSV</button>
    </div>
    <table>
        <thead>
            <tr>
                <th>Device ID</th>
                <th>Host</th>
                <th>Usuario</th>
                <th>Aula</th>
                <th>CPU %</th>
                <th>RAM %</th>
                <th>Estado</th>
                <th>Hace</th>
                <th>Visto</th>
            </tr>
        </thead>
        <tbody id="device-table-body">
            
        </tbody>
    </table>
    <script>
    (function(){
        const dlBtn = document.getElementById('downloadCsv');
        const summaryEl = document.getElementById('summary');
        const tableBody = document.getElementById('device-table-body');

        function timeAgo(isoString) {
            const date = new Date(isoString);
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " años";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " meses";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " días";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " horas";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutos";
            return Math.floor(seconds) + " segundos";
        }

        async function refreshData() {
            try {
                const response = await fetch('/api/v1/devices');
                if (!response.ok) {
                    console.error('Error fetching devices:', response.statusText);
                    return;
                }
                const data = await response.json();
                const devices = data.devices || [];

                // Update summary
                const total = devices.length;
                const online = devices.filter(d => d.status === 'active' || d.status === 'connected').length;
                const inactive = devices.filter(d => d.status === 'inactive').length;
                const disconnected = devices.filter(d => d.status === 'disconnected').length;
                summaryEl.textContent = `Total: ${total} | En línea: ${online} | Inactivo: ${inactive} | Desconectado: ${disconnected}`;

                // Populate table
                tableBody.innerHTML = '';
                devices.forEach(device => {
                    const row = document.createElement('tr');
                    const metrics = device.metrics || {};
                    row.innerHTML = `
                        <td>${device.device_id}</td>
                        <td>${device.hostname}</td>
                        <td>${device.username}</td>
                        <td>${device.classroom_id}</td>
                        <td>${metrics.cpu_percent || 'N/A'}</td>
                        <td>${metrics.mem_percent || 'N/A'}</td>
                        <td><span class="dot status-${device.status}"></span> ${device.status}</td>
                        <td>${timeAgo(device.last_heartbeat)}</td>
                        <td>${new Date(device.last_heartbeat).toLocaleString()}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        function exportCsv(){
            const table = document.querySelector('table');
            const rows = Array.from(table.querySelectorAll('tr'));
            const csv = rows.map((tr, idx) => {
                const cells = Array.from(tr.querySelectorAll(idx === 0 ? 'th' : 'td'));
                return cells.map(td => '"' + (td.innerText||"").replace(/"/g,'""') + '"').join(',');
            }).join('\n');
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'edumon_dashboard.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        // Event wiring
        dlBtn.addEventListener('click', exportCsv);

        // Initialize
        refreshData();
        setInterval(refreshData, 5000); // Refresh every 5 seconds
    })();
    </script>
</body>
</html>