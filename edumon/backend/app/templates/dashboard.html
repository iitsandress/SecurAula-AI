<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EduMon Dashboard ÂÆûÊó∂</title>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --bg-gradient: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            --online-color: #28a745;
            --offline-color: #dc3545;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background: var(--bg-gradient); min-height: 100vh; color: #333; }
        .header { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); color: white; padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .header h1 { font-size: 2.5em; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: rgba(255,255,255,0.95); padding: 25px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); text-align: center; backdrop-filter: blur(10px); }
        .stat-number { font-size: 3em; font-weight: bold; color: var(--primary-color); }
        .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--bg-gradient); color: white; padding: 15px; text-align: left; cursor: pointer; user-select: none; }
        th:hover { background: linear-gradient(135deg, #768eea, #865bb2); }
        th .sort-indicator { float: right; opacity: 0.7; }
        td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; transition: background 0.3s; }
        tr:last-child td { border-bottom: none; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 500; }
        .status-badge.online { background: rgba(40, 167, 69, 0.1); color: var(--online-color); }
        .status-badge.offline { background: rgba(220, 53, 69, 0.1); color: var(--offline-color); }
        .metric-bar { position: relative; background: #e9ecef; border-radius: 8px; height: 20px; overflow: hidden; }
        .metric-fill { background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; transition: width 0.3s ease; }
        #loading-spinner { text-align: center; padding: 50px; font-size: 1.5em; color: #666; }
        .footer { text-align: center; margin-top: 30px; color: rgba(255,255,255,0.8); }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéì EduMon Dashboard ÂÆûÊó∂</h1>
    </div>
    <div class="container">
        <div class="stats">
            <div class="stat-card"><div class="stat-number" id="stat-total">-</div><div>üìä Total</div></div>
            <div class="stat-card"><div class="stat-number" id="stat-online">-</div><div>üü¢ En L√≠nea</div></div>
            <div class="stat-card"><div class="stat-number" id="stat-offline">-</div><div>üî¥ Desconectados</div></div>
            <div class="stat-card"><div class="stat-number" id="stat-connectivity">-</div><div>üìà Conectividad</div></div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th data-sort="hostname">üíª Hostname <span class="sort-indicator"></span></th>
                        <th data-sort="username">üë§ Usuario <span class="sort-indicator"></span></th>
                        <th data-sort="classroom">üè´ Aula <span class="sort-indicator"></span></th>
                        <th data-sort="cpu">üî• CPU <span class="sort-indicator"></span></th>
                        <th data-sort="mem">üß† RAM <span class="sort-indicator"></span></th>
                        <th data-sort="uptime">‚è±Ô∏è Uptime <span class="sort-indicator"></span></th>
                        <th data-sort="last_seen_seconds">üì° Estado <span class="sort-indicator"></span></th>
                    </tr>
                </thead>
                <tbody id="clients-table-body">
                    <tr><td colspan="7" id="loading-spinner">Cargando datos...</td></tr>
                </tbody>
            </table>
        </div>
        <div class="footer">
            <p>EduMon v4.0 - Actualizaciones en tiempo real</p>
        </div>
    </div>

    <script>
        const API_KEY = '{{ api_key }}';
        const API_ENDPOINT = `/api/v1/clients/status?api_key=${API_KEY}`;
        const tableBody = document.getElementById('clients-table-body');
        const headers = document.querySelectorAll('th[data-sort]');

        let clientsData = [];
        let sortState = { column: 'last_seen_seconds', direction: 'asc' };

        function renderTable() {
            // Sort data
            clientsData.sort((a, b) => {
                let valA = a[sortState.column];
                let valB = b[sortState.column];
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Update headers
            headers.forEach(th => {
                const indicator = th.querySelector('.sort-indicator');
                if (th.dataset.sort === sortState.column) {
                    indicator.textContent = sortState.direction === 'asc' ? '‚ñ≤' : '‚ñº';
                } else {
                    indicator.textContent = '';
                }
            });

            if (clientsData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;">üì≠ No hay estudiantes conectados</td></tr>';
                return;
            }

            tableBody.innerHTML = clientsData.map(client => `
                <tr>
                    <td><strong>${client.hostname}</strong></td>
                    <td>${client.username}</td>
                    <td>${client.classroom}</td>
                    <td><div class="metric-bar"><div class="metric-fill" style="width: ${client.cpu}%"></div></div> ${client.cpu}%</td>
                    <td><div class="metric-bar"><div class="metric-fill" style="width: ${client.mem}%"></div></div> ${client.mem}%</td>
                    <td>${client.uptime_str}</td>
                    <td><span class="status-badge ${client.status_class}">${client.status}</span></td>
                </tr>
            `).join('');
        }

        function updateStats(stats) {
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-online').textContent = stats.online;
            document.getElementById('stat-offline').textContent = stats.offline;
            document.getElementById('stat-connectivity').textContent = `${stats.connectivity_percentage}%`;
        }

        async function fetchData() {
            try {
                const response = await fetch(API_ENDPOINT);
                if (!response.ok) {
                    tableBody.innerHTML = `<tr><td colspan="7">Error: ${response.statusText}</td></tr>`;
                    return;
                }
                const data = await response.json();
                clientsData = data.clients;
                updateStats(data.stats);
                renderTable();
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="7">Error de conexi√≥n con el servidor.</td></tr>`;
                console.error("Fetch error:", error);
            }
        }

        headers.forEach(header => {
            header.addEventListener('click', () => {
                const column = header.dataset.sort;
                if (sortState.column === column) {
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.column = column;
                    sortState.direction = 'asc';
                }
                renderTable();
            });
        });

        // Initial fetch and interval
        fetchData();
        setInterval(fetchData, 5000); // Refresh every 5 seconds
    </script>
</body>
</html>